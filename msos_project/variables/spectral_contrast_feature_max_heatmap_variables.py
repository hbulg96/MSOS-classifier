import numpy
import matplotlib
from matplotlib import pyplot
import scipy
from scipy import signal
from scipy.io.wavfile import read
from scipy.io.wavfile import write
import os
import timeit
import traceback
import msos_project
from msos_project import *
from msos_project.dsp_tools import *
import msos_project.dsp_tools.peakdetection as peakdetection
import msos_project.dsp_tools.peakflatten as peakflatten
import msos_project.dsp_tools.rhythmdetection as rhythmdetection
import msos_project.dsp_tools.find_similar_magnitude_peaks as find_similar_magnitude_peaks
import msos_project.dsp_tools.find_rhythmic_packets as find_rhythmic_packets
from numpy import random
import msos_project.classification_1_rhythm_time_domain_v0_standalone as classifier1
import msos_project.dsp_tools.spectral_centroid_classifier as spectral_centroid_classifier
from scipy import stats
from numpy import polyfit


all_xedges =  [[ 66. ,  83.6, 101.2, 118.8, 136.4, 154. , 171.6, 189.2, 206.8,
       224.4, 242. , 259.6, 277.2, 294.8, 312.4, 330. , 347.6, 365.2,
       382.8, 400.4, 418. ], [ 19.  ,  38.35,  57.7 ,  77.05,  96.4 , 115.75, 135.1 , 154.45,
       173.8 , 193.15, 212.5 , 231.85, 251.2 , 270.55, 289.9 , 309.25,
       328.6 , 347.95, 367.3 , 386.65, 406.  ], [ 24. ,  42.9,  61.8,  80.7,  99.6, 118.5, 137.4, 156.3, 175.2,
       194.1, 213. , 231.9, 250.8, 269.7, 288.6, 307.5, 326.4, 345.3,
       364.2, 383.1, 402. ], [ 25.  ,  43.55,  62.1 ,  80.65,  99.2 , 117.75, 136.3 , 154.85,
       173.4 , 191.95, 210.5 , 229.05, 247.6 , 266.15, 284.7 , 303.25,
       321.8 , 340.35, 358.9 , 377.45, 396.], [ 17. ,  37.4,  57.8,  78.2,  98.6, 119. , 139.4, 159.8, 180.2,
       200.6, 221. , 241.4, 261.8, 282.2, 302.6, 323. , 343.4, 363.8,
       384.2, 404.6, 425. ]]


all_yedges = [[ 57.  ,  75.65,  94.3 , 112.95, 131.6 , 150.25, 168.9 , 187.55,
       206.2 , 224.85, 243.5 , 262.15, 280.8 , 299.45, 318.1 , 336.75,
       355.4 , 374.05, 392.7 , 411.35, 430.  ], [ 35. ,  54.8,  74.6,  94.4, 114.2, 134. , 153.8, 173.6, 193.4,
       213.2, 233. , 252.8, 272.6, 292.4, 312.2, 332. , 351.8, 371.6,
       391.4, 411.2, 431.], [ 49. ,  68.1,  87.2, 106.3, 125.4, 144.5, 163.6, 182.7, 201.8,
       220.9, 240. , 259.1, 278.2, 297.3, 316.4, 335.5, 354.6, 373.7,
       392.8, 411.9, 431.], [ 45. ,  64.3,  83.6, 102.9, 122.2, 141.5, 160.8, 180.1, 199.4,
       218.7, 238. , 257.3, 276.6, 295.9, 315.2, 334.5, 353.8, 373.1,
       392.4, 411.7, 431. ], [ 17. ,  37.7,  58.4,  79.1,  99.8, 120.5, 141.2, 161.9, 182.6,
       203.3, 224. , 244.7, 265.4, 286.1, 306.8, 327.5, 348.2, 368.9,
       389.6, 410.3, 431. ]]

all_heatmaps = [[[1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [0., 1., 0., 0., 1., 0., 0., 0., 0., 2., 0., 0., 0., 1., 0., 0.,
        1., 0., 0., 1.],
       [0., 0., 0., 0., 4., 0., 2., 0., 0., 0., 1., 0., 1., 0., 0., 1.,
        0., 0., 0., 1.],
       [0., 0., 1., 2., 1., 1., 1., 1., 2., 2., 1., 1., 0., 0., 0., 0.,
        0., 0., 0., 2.],
       [0., 0., 1., 1., 3., 2., 0., 0., 1., 2., 2., 1., 0., 1., 0., 1.,
        1., 0., 2., 2.],
       [1., 2., 2., 3., 1., 0., 2., 0., 0., 2., 2., 0., 2., 1., 2., 2.,
        1., 0., 3., 3.],
       [1., 0., 0., 4., 0., 2., 0., 2., 0., 4., 0., 2., 0., 0., 1., 3.,
        1., 0., 2., 2.],
       [0., 1., 1., 1., 4., 1., 2., 0., 1., 1., 1., 0., 0., 4., 0., 1.,
        1., 1., 2., 3.],
       [0., 0., 3., 2., 2., 4., 2., 4., 1., 0., 3., 2., 1., 0., 1., 1.,
        0., 1., 4., 3.],
       [0., 1., 0., 4., 0., 0., 3., 1., 1., 2., 0., 1., 3., 2., 0., 0.,
        0., 2., 0., 0.],
       [0., 0., 1., 0., 3., 2., 1., 1., 3., 1., 2., 0., 0., 0., 0., 0.,
        0., 0., 2., 3.],
       [0., 0., 0., 3., 2., 0., 0., 3., 2., 5., 2., 0., 1., 2., 1., 0.,
        3., 0., 0., 2.],
       [0., 1., 0., 0., 0., 2., 1., 0., 2., 0., 1., 1., 1., 0., 1., 0.,
        1., 1., 0., 1.],
       [0., 1., 0., 1., 1., 4., 2., 1., 2., 0., 0., 1., 0., 2., 0., 0.,
        1., 3., 2., 1.],
       [1., 0., 0., 1., 1., 1., 2., 0., 0., 0., 0., 1., 2., 0., 2., 0.,
        0., 1., 1., 0.],
       [0., 1., 0., 1., 0., 0., 0., 1., 1., 0., 0., 1., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [0., 0., 1., 0., 1., 2., 3., 0., 2., 1., 1., 0., 0., 0., 0., 0.,
        1., 0., 0., 0.],
       [0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0.,
        1., 1., 1., 0.]], [[ 1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  1.,  2.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  2.,  0.,  0.,  0.,  1.,  1.,  2.,  0.,  0.,  0.,  0.,  1.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  0.,  0.,  1.,  0.,  0.,  0.,  0.,  0.,  1.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  1.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  1.,  0.,  1.,  1.,  0.,  0.,  1.,  1.,  1.,  0.,  0.,  0.,
         1.,  0.,  0.,  0.,  0.,  1.,  2.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  1.,  1.,  0.,
         1.,  1.,  1.,  1.,  1.,  0.,  4.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  1.,  0.,  2.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  1.,  1.,  8.],
       [ 0.,  0.,  0.,  0.,  1.,  0.,  0.,  2.,  0.,  0.,  2.,  1.,  0.,
         0.,  0.,  0.,  0.,  2.,  1., 27.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  2.,  1.,  0.,
         0.,  3.,  0.,  3.,  2.,  5., 38.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  1.,  2.,  1.,  1.,
         2.,  1.,  0.,  2.,  3.,  4., 27.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  2.,  0.,  1.,  0.,
         3.,  1.,  1.,  1.,  4.,  2., 21.],
       [ 1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         1.,  2.,  0.,  1.,  2.,  3., 20.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  1.,  3.,  2.,  9.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  1.,  0.,  0.,  0.,  0.,  1.,  1.,
         0.,  1.,  1.,  1.,  2.,  0.,  9.],
       [ 0.,  0.,  0.,  1.,  0.,  0.,  0.,  0.,  1.,  0.,  0.,  1.,  0.,
         0.,  0.,  1.,  0.,  0.,  0.,  7.],
       [ 0.,  0.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  2.],
       [ 0.,  0.,  0.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  1.],
       [ 0.,  0.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  2.]], [[ 5.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 2.,  1.,  2.,  1.,  0.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  1.,  0.,  1.,  1.,  2.,  0.,  1.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  0.,  0.,  2.,  1.,  2.,  1.,  0.,  0.,  1.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  1.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  1.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  1.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  1.,  0.,  0.,  1.,  0.,  0.,
         2.,  0.,  0.,  0.,  0.,  0.,  6.],
       [ 0.,  0.,  0.,  0.,  1.,  0.,  0.,  1.,  0.,  1.,  0.,  0.,  0.,
         1.,  2.,  1.,  0.,  1.,  0., 13.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  1.,  2.,  0.,  2.,  0.,  0.,  1.,
         1.,  1.,  2.,  0.,  2.,  1., 20.],
       [ 0.,  0.,  0.,  0.,  0.,  3.,  0.,  2.,  0.,  1.,  2.,  4.,  0.,
         0.,  1.,  2.,  3.,  2.,  1., 27.],
       [ 0.,  0.,  0.,  0.,  1.,  1.,  0.,  0.,  0.,  2.,  0.,  0.,  1.,
         0.,  2.,  0.,  3.,  0.,  4., 31.],
       [ 0.,  0.,  0.,  0.,  1.,  1.,  0.,  0.,  0.,  1.,  0.,  1.,  1.,
         0.,  1.,  1.,  2.,  2.,  0., 23.],
       [ 0.,  0.,  0.,  0.,  0.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  1.,
         2.,  1.,  0.,  2.,  1.,  1., 16.],
       [ 0.,  0.,  1.,  0.,  0.,  0.,  1.,  0.,  0.,  1.,  0.,  1.,  0.,
         0.,  0.,  0.,  0.,  0.,  0., 10.],
       [ 0.,  0.,  0.,  0.,  0.,  1.,  0.,  0.,  1.,  0.,  1.,  0.,  0.,
         0.,  0.,  1.,  0.,  1.,  0.,  7.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  1.,  0.,  0.,  2.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  4.],
       [ 0.,  0.,  0.,  0.,  0.,  1.,  0.,  1.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  2.,  1.],
       [ 0.,  0.,  1.,  1.,  1.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  2.],
       [ 0.,  3.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  1.,  0.,  0.,  0.,  0.],
       [ 1.,  3.,  0.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  1.]], [[ 2.,  3.,  2.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  2.,  2.,  2.,  3.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 1.,  1.,  0.,  1.,  3.,  0.,  2.,  0.,  0.,  1.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  0.,  1.,  2.,  1.,  2.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 1.,  0.,  0.,  0.,  0.,  0.,  2.,  0.,  2.,  0.,  1.,  0.,  0.,
         0.,  1.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  1.,  0.,  0.,  1.,  0.,  1.,  1.,  1.,  1.,  1.,  0.,
         1.,  1.,  0.,  0.,  1.,  0.,  2.],
       [ 0.,  0.,  0.,  0.,  0.,  1.,  0.,  1.,  1.,  0.,  1.,  2.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  3.],
       [ 0.,  0.,  0.,  0.,  0.,  1.,  0.,  0.,  0.,  2.,  2.,  0.,  1.,
         0.,  0.,  0.,  2.,  1.,  2., 15.],
       [ 0.,  0.,  0.,  0.,  0.,  1.,  0.,  0.,  0.,  1.,  1.,  0.,  0.,
         0.,  0.,  0.,  1.,  3.,  2., 20.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  1.,  0.,  1.,  0.,  1.,  0.,  2.,
         2.,  1.,  1.,  2.,  5.,  6., 35.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  1.,  2.,  3.,  0.,  0.,
         1.,  0.,  5.,  3.,  1.,  4., 22.],
       [ 0.,  0.,  0.,  0.,  0.,  1.,  0.,  0.,  1.,  1.,  0.,  0.,  0.,
         1.,  0.,  0.,  3.,  5.,  4., 15.],
       [ 0.,  0.,  1.,  1.,  1.,  0.,  0.,  0.,  0.,  0.,  1.,  0.,  2.,
         1.,  0.,  0.,  1.,  0.,  3.,  9.],
       [ 0.,  0.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  5.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         1.,  0.,  2.,  0.,  0.,  0.,  3.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  1.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  1.],
       [ 0.,  1.,  0.,  0.,  0.,  1.,  2.,  3.,  0.,  0.,  0.,  0.,  0.,
         0.,  1.,  1.,  0.,  0.,  0.,  2.],
       [ 0.,  0.,  2.,  0.,  2.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  2.,  1.,  0.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  1.,  0.,  0.],
       [ 1.,  0.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.]], [[ 4.,  2.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [10.,  7.,  7.,  3.,  4.,  0.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  1.,  0.,  0.,  0.,  0.],
       [ 4.,  7.,  3.,  6.,  4.,  2.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  2.,  9.,  2.,  6.,  3.,  2.,  1.,  1.,  1.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 1.,  2.,  4.,  4.,  1.,  5.,  3.,  1.,  1.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  1.,  0.,  0.,  0.],
       [ 2.,  0.,  1.,  5.,  1.,  1.,  0.,  1.,  0.,  0.,  1.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  1.],
       [ 0.,  0.,  0.,  1.,  0.,  2.,  0.,  1.,  4.,  3.,  0.,  1.,  0.,
         0.,  1.,  0.,  0.,  0.,  0.,  1.],
       [ 0.,  1.,  1.,  0.,  0.,  0.,  1.,  0.,  0.,  0.,  1.,  1.,  0.,
         0.,  1.,  0.,  0.,  1.,  0.,  6.],
       [ 0.,  0.,  0.,  0.,  1.,  0.,  0.,  1.,  0.,  1.,  0.,  1.,  1.,
         1.,  1.,  0.,  2.,  0.,  2.,  7.],
       [ 0.,  0.,  0.,  0.,  0.,  2.,  1.,  2.,  1.,  1.,  0.,  0.,  1.,
         0.,  1.,  1.,  1.,  2.,  1.,  4.],
       [ 0.,  0.,  0.,  0.,  1.,  1.,  0.,  1.,  3.,  0.,  1.,  1.,  1.,
         1.,  2.,  1.,  1.,  1.,  0., 11.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  1.,  0.,  1.,  1.,  0.,  0.,  1.,
         0.,  0.,  0.,  0.,  0.,  1.,  4.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  2.,  1.,  0.,  0.,  0.,  2.],
       [ 0.,  0.,  0.,  0.,  0.,  1.,  0.,  0.,  2.,  0.,  1.,  1.,  0.,
         1.,  0.,  0.,  0.,  0.,  0.,  1.],
       [ 0.,  0.,  0.,  1.,  1.,  0.,  0.,  0.,  1.,  1.,  0.,  1.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  4.],
       [ 0.,  0.,  3.,  2.,  3.,  0.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  1.,  1.],
       [ 0.,  1.,  2.,  1.,  1.,  1.,  2.,  1.,  1.,  1.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  1.],
       [ 2.,  5.,  4.,  2.,  1.,  1.,  1.,  1.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 1.,  5.,  1.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 3.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  1.,  0.]]]

def max_value(input_list):

    max_values = []
    for x in range(len(input_list)):
        current_category = input_list[x]
        max_values.append( max(current_category))
        pass
    max_value = max(max_values)
    return(max_value)

"""
Heatmap for each category is divided by the largest heatmap value of the category,
which produces a 2d space of values between 0 and 1, which will be our weights for categorization
"""

for category in all_heatmaps:

    max_val_of_category = max_value(category)
    #print("max_val_of_category = ", max_val_of_category)

    for row_list in category:

        for x in range(len(row_list)):
            current_val = row_list[x]  # find current value
            row_list[x] = current_val / max_val_of_category  # replace with value between 0 and 1

            pass

        pass

#print("All heatmap values = ", all_heatmaps)



