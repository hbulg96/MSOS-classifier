import numpy
import matplotlib
from matplotlib import pyplot
import scipy
from scipy import signal
from scipy.io.wavfile import read
from scipy.io.wavfile import write
import os
import timeit
import traceback
import msos_project
from msos_project import *
from msos_project.dsp_tools import *
import msos_project.dsp_tools.peakdetection as peakdetection
import msos_project.dsp_tools.peakflatten as peakflatten
import msos_project.dsp_tools.rhythmdetection as rhythmdetection
import msos_project.dsp_tools.find_similar_magnitude_peaks as find_similar_magnitude_peaks
import msos_project.dsp_tools.find_rhythmic_packets as find_rhythmic_packets
from numpy import random
import msos_project.classification_1_rhythm_time_domain_v0_standalone as classifier1
import msos_project.dsp_tools.spectral_centroid_classifier as spectral_centroid_classifier
from scipy import stats
from numpy import polyfit


all_xedges =  [[15.37846469, 16.68059301, 17.98272132, 19.28484964, 20.58697795,
       21.88910627, 23.19123458, 24.4933629 , 25.79549121, 27.09761953,
       28.39974785, 29.70187616, 31.00400448, 32.30613279, 33.60826111,
       34.91038942, 36.21251774, 37.51464605, 38.81677437, 40.11890269,
       41.421031  ], [12.41907404, 14.30280497, 16.1865359 , 18.07026683, 19.95399776,
       21.83772869, 23.72145963, 25.60519056, 27.48892149, 29.37265242,
       31.25638335, 33.14011428, 35.02384521, 36.90757614, 38.79130708,
       40.67503801, 42.55876894, 44.44249987, 46.3262308 , 48.20996173,
       50.09369266], [ 7.21573221,  9.56212464, 11.90851706, 14.25490949, 16.60130192,
       18.94769434, 21.29408677, 23.64047919, 25.98687162, 28.33326405,
       30.67965647, 33.0260489 , 35.37244132, 37.71883375, 40.06522618,
       42.4116186 , 44.75801103, 47.10440345, 49.45079588, 51.79718831,
       54.14358073], [ 7.03849243,  8.96226084, 10.88602926, 12.80979767, 14.73356609,
       16.6573345 , 18.58110292, 20.50487134, 22.42863975, 24.35240817,
       26.27617658, 28.199945  , 30.12371341, 32.04748183, 33.97125024,
       35.89501866, 37.81878707, 39.74255549, 41.6663239 , 43.59009232,
       45.51386073], [ 6.62363548,  8.71848921, 10.81334294, 12.90819667, 15.0030504 ,
       17.09790413, 19.19275786, 21.28761158, 23.38246531, 25.47731904,
       27.57217277, 29.6670265 , 31.76188023, 33.85673396, 35.95158769,
       38.04644142, 40.14129515, 42.23614888, 44.33100261, 46.42585634,
       48.52071007]]


all_yedges = [[0.03327003, 0.05163889, 0.07000775, 0.08837661, 0.10674547,
       0.12511434, 0.1434832 , 0.16185206, 0.18022092, 0.19858978,
       0.21695864, 0.23532751, 0.25369637, 0.27206523, 0.29043409,
       0.30880295, 0.32717181, 0.34554067, 0.36390954, 0.3822784 ,
       0.40064726], [0.02393452, 0.06823039, 0.11252626, 0.15682212, 0.20111799,
       0.24541386, 0.28970973, 0.3340056 , 0.37830147, 0.42259734,
       0.46689321, 0.51118908, 0.55548495, 0.59978082, 0.64407668,
       0.68837255, 0.73266842, 0.77696429, 0.82126016, 0.86555603,
       0.9098519 ], [0.0208774 , 0.09710471, 0.17333202, 0.24955933, 0.32578664,
       0.40201395, 0.47824126, 0.55446856, 0.63069587, 0.70692318,
       0.78315049, 0.8593778 , 0.93560511, 1.01183242, 1.08805973,
       1.16428703, 1.24051434, 1.31674165, 1.39296896, 1.46919627,
       1.54542358], [0.02810117, 0.09099237, 0.15388357, 0.21677477, 0.27966597,
       0.34255716, 0.40544836, 0.46833956, 0.53123076, 0.59412196,
       0.65701316, 0.71990435, 0.78279555, 0.84568675, 0.90857795,
       0.97146915, 1.03436035, 1.09725155, 1.16014274, 1.22303394,
       1.28592514], [0.03824927, 0.09918008, 0.1601109 , 0.22104171, 0.28197252,
       0.34290334, 0.40383415, 0.46476497, 0.52569578, 0.5866266 ,
       0.64755741, 0.70848823, 0.76941904, 0.83034986, 0.89128067,
       0.95221149, 1.0131423 , 1.07407311, 1.13500393, 1.19593474,
       1.25686556]]

all_heatmaps = [[[0., 0., 0., 0., 0., 2., 0., 0., 1., 1., 0., 0., 0., 0., 1., 1.,
        0., 0., 0., 0.],
       [0., 0., 0., 0., 2., 2., 0., 1., 0., 0., 0., 1., 1., 0., 1., 1.,
        1., 0., 1., 0.],
       [0., 0., 0., 0., 1., 0., 3., 1., 0., 0., 0., 0., 0., 4., 0., 1.,
        1., 0., 1., 0.],
       [0., 0., 1., 3., 0., 1., 0., 1., 1., 2., 4., 5., 4., 1., 3., 0.,
        1., 0., 0., 1.],
       [0., 0., 0., 0., 3., 3., 1., 1., 1., 5., 1., 2., 3., 2., 2., 1.,
        0., 0., 0., 1.],
       [0., 0., 2., 0., 3., 0., 3., 3., 1., 3., 3., 3., 2., 0., 1., 2.,
        1., 0., 1., 1.],
       [0., 1., 3., 3., 2., 5., 2., 4., 4., 4., 2., 0., 0., 0., 0., 1.,
        0., 0., 0., 0.],
       [0., 0., 3., 6., 6., 3., 4., 2., 1., 2., 1., 3., 0., 0., 0., 1.,
        2., 1., 0., 0.],
       [0., 1., 4., 2., 2., 1., 2., 5., 4., 3., 0., 1., 1., 0., 1., 1.,
        0., 0., 0., 0.],
       [1., 1., 2., 0., 1., 1., 1., 2., 2., 2., 3., 3., 0., 1., 1., 0.,
        0., 0., 0., 0.],
       [0., 3., 1., 2., 2., 1., 1., 1., 1., 2., 2., 0., 1., 1., 0., 0.,
        0., 0., 0., 0.],
       [2., 0., 1., 1., 2., 2., 1., 1., 2., 1., 0., 4., 0., 0., 1., 0.,
        0., 0., 0., 0.],
       [1., 1., 0., 2., 2., 0., 0., 0., 1., 1., 1., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [2., 1., 0., 0., 1., 1., 2., 1., 1., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [1., 1., 0., 1., 1., 1., 0., 2., 0., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [1., 0., 0., 0., 2., 0., 0., 1., 0., 0., 0., 1., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 1., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [1., 0., 0., 1., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.]], [[ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  1.,  0.,  0.,  0.,  0.,  0.,
         0.,  2.,  0.,  0.,  0.,  0.,  1.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  1.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  1.,  0.,  0.,  0.,  0.,
         0.,  1.,  0.,  1.,  1.,  0.,  0.],
       [ 0.,  0.,  0.,  1.,  0.,  0.,  0.,  1.,  1.,  0.,  1.,  0.,  0.,
         0.,  1.,  0.,  0.,  0.,  0.,  0.],
       [ 1.,  0.,  0.,  2.,  0.,  0.,  1.,  0.,  0.,  1.,  1.,  0.,  1.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 1.,  1.,  2.,  3.,  2.,  0.,  0.,  1.,  0.,  1.,  0.,  1.,  1.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 1.,  1.,  1.,  1.,  2.,  3.,  4.,  2.,  1.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 3.,  1.,  2.,  2.,  1.,  2.,  0.,  1.,  1.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 2.,  3.,  4.,  5.,  3.,  3.,  1.,  1.,  1.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [13.,  4.,  6.,  5.,  0.,  2.,  2.,  1.,  0.,  1.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [24.,  4.,  2.,  6.,  3.,  3.,  0.,  1.,  2.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [16.,  7.,  5.,  3.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [16.,  2.,  1.,  2.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [11.,  4.,  3.,  0.,  0.,  0.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 7.,  5.,  3.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [14.,  6.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 9.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 6.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 3.,  1.,  2.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 3.,  0.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.]], [[ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  1.,  0.,
         0.,  0.,  0.,  0.,  0.,  1.,  2.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  1.,  0.,  0.,  0.,  2.,  0.,  0.,
         2.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  0.,  0.,  0.,  1.,  0.,  1.,  0.,  3.,  0.,  0.,  2.,
         2.,  0.,  0.,  1.,  0.,  0.,  0.],
       [ 0.,  0.,  0.,  0.,  1.,  1.,  2.,  0.,  0.,  3.,  0.,  0.,  1.,
         1.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  3.,  1.,  0.,  1.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 1.,  3.,  3.,  2.,  1.,  2.,  0.,  0.,  0.,  1.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 1.,  2.,  2.,  5.,  1.,  1.,  1.,  2.,  0.,  2.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 2.,  8.,  2.,  3.,  1.,  2.,  4.,  2.,  0.,  1.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 5.,  7.,  5.,  0.,  1.,  2.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [11.,  5.,  5.,  2.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [10.,  7.,  4.,  3.,  1.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [15.,  9.,  6.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [10., 12.,  2.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 9., 10.,  4.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [19.,  5.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [13.,  6.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [12.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 5.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 2.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.]], [[ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  1.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  1.,  0.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  1.,  0.,  0.,  1.,  1.,
         2.,  0.,  1.,  0.,  0.,  0.,  1.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  1.,  0.,  1.,  1.,  2.,  0.,
         0.,  1.,  1.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  2.,  1.,  0.,  0.,  2.,  2.,  1.,  3.,  0.,  2.,  1.,
         0.,  2.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  1.,  0.,  2.,  0.,  1.,  0.,  2.,  4.,  3.,  1.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 2.,  0.,  0.,  0.,  0.,  4.,  1.,  2.,  2.,  2.,  1.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  2.,  2.,  5.,  0.,  1.,  0.,  0.,  1.,  0.,  1.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  1.,  1.,  0.,  1.,  1.,  2.,  0.,  1.,  1.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 1.,  1.,  3.,  4.,  5.,  2.,  4.,  1.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 3.,  5.,  5.,  4.,  2.,  1.,  3.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 1.,  6.,  9.,  3.,  0.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 6., 15.,  6.,  8.,  0.,  2.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 8., 14.,  8.,  4.,  1.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 6.,  9.,  9.,  2.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 9., 12.,  4.,  1.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 3.,  7.,  3.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 6.,  2.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 2.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 4.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.]], [[0., 0., 0., 0., 0., 0., 0., 0., 3., 1., 5., 1., 1., 1., 1., 0.,
        0., 2., 0., 0.],
       [0., 0., 0., 0., 1., 2., 2., 1., 0., 5., 2., 2., 2., 2., 1., 0.,
        2., 1., 0., 1.],
       [0., 0., 1., 1., 4., 2., 6., 5., 2., 3., 1., 1., 3., 2., 2., 1.,
        0., 0., 1., 0.],
       [0., 2., 4., 2., 0., 5., 2., 4., 3., 2., 3., 0., 0., 1., 0., 0.,
        0., 0., 0., 0.],
       [1., 1., 3., 1., 6., 6., 1., 0., 1., 2., 0., 1., 0., 0., 0., 0.,
        0., 1., 0., 0.],
       [0., 2., 1., 6., 5., 4., 3., 2., 2., 1., 0., 1., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [0., 4., 1., 4., 1., 1., 1., 0., 2., 0., 2., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [0., 2., 2., 4., 0., 3., 0., 1., 1., 2., 0., 1., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [1., 1., 2., 1., 0., 1., 2., 1., 2., 1., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [4., 4., 5., 1., 1., 0., 1., 2., 1., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [0., 4., 4., 3., 3., 1., 3., 0., 2., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [4., 5., 3., 3., 2., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [1., 3., 3., 1., 0., 1., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [4., 6., 2., 0., 1., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [3., 6., 1., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [2., 0., 0., 0., 2., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [0., 0., 1., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [0., 1., 1., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.],
       [1., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0.]]]


def max_value(input_list):

    max_values = []
    for x in range(len(input_list)):
        current_category = input_list[x]
        max_values.append( max(current_category))
        pass
    max_value = max(max_values)
    return(max_value)

"""
Heatmap for each category is divided by the largest heatmap value of the category,
which produces a 2d space of values between 0 and 1, which will be our weights for categorization
"""

for category in all_heatmaps:

    max_val_of_category = max_value(category)
    #print("max_val_of_category = ", max_val_of_category)

    for row_list in category:

        for x in range(len(row_list)):
            current_val = row_list[x]  # find current value
            row_list[x] = current_val / max_val_of_category  # replace with value between 0 and 1

            pass

        pass

#print("All heatmap values = ", all_heatmaps)



